workflow: 
  rules: 
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*$/
      variables: 
        IMAGE_TAG: "feat"
    - if: $CI_COMMIT_BRANCH =~ /^hotfix\/.*$/    
      variables: 
        IMAGE_TAG: "hf"
    - if: $CI_COMMIT_BRANCH == "develop"
      variables: 
        IMAGE_TAG: "dev"
    - if: $CI_COMMIT_BRANCH =~ /^release\/(\d+\.\d+\.\d+)$/
      variables: 
        IMAGE_TAG: "stage"
    - if: $CI_COMMIT_TAG =~ /^(\d+\.\d+\.\d+)$/
      variables: 
        IMAGE_TAG: $CI_COMMIT_TAG

stages:
  - build-and-push
  - test
  - deploy
  - deploy-prod

build-and-push:
  stage: build-and-push
  extends: .kaniko
  variables: 
    KANIKO_TARGET: runtime

unit-tests:
  stage: test
  image: golang:1.22
  script: 
    - go test -v -coverpkg=./... -coverprofile=profile.cov ./...
    - go tool cover -func profile.cov

lint:
  stage: test
  rules: 
    - if: $CI_COMMIT_TAG =~ /^(\d+\.\d+\.\d+)$/
      when: never
    - when: on_success
  script: 
    - echo "This is a lint stub"

.kaniko: 
  image: gcr.io/kaniko-project/executor:v1.23.2-debug
  script: 
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$REGISTRY_URL\":{\"auth\":\"$(echo -n "${REGISTRY_USERNAME}:${REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
    - echo "/kaniko/executor 
      --destination ${REGISTRY_USERNAME}/${CI_PROJECT_NAME}:${IMAGE_TAG}
      --context "."
      --target $KANIKO_TARGET
      --skip-unused-stages
      --cache=true 
      --cache-repo ${REGISTRY_USERNAME}/${CI_PROJECT_NAME}-cache
      --cache-ttl 48h 
      "
    - /kaniko/executor 
      --destination ${REGISTRY_USERNAME}/${CI_PROJECT_NAME}:${IMAGE_TAG}
      --context "." 
      --target $KANIKO_TARGET
      --skip-unused-stages
      --cache=true 
      --cache-repo ${REGISTRY_USERNAME}/${CI_PROJECT_NAME}-cache
      --cache-ttl 48h 

.deploy-template:
  image: bdv21/deploy-image:1.0.0
  script: 
    - helm repo add m8x https://MadEngineX.github.io/helm-charts/
    - helm repo update
    - echo "helm -n ${NAMESPACE_NAME}-${DEPLOY_ENV} upgrade --install ${CI_PROJECT_NAME} m8x/common-chart -f deploy/${DEPLOY_ENV}/values.yaml  --set image.repository=${REGISTRY_USERNAME}/${CI_PROJECT_NAME} --set image.tag=${IMAGE_TAG}"
    - helm -n ${NAMESPACE_NAME}-${DEPLOY_ENV} upgrade --install ${CI_PROJECT_NAME} m8x/common-chart -f deploy/${DEPLOY_ENV}/values.yaml  --set image.repository=${REGISTRY_USERNAME}/${CI_PROJECT_NAME} --set image.tag=${IMAGE_TAG} 

deploy:
  stage: deploy
  extends: .deploy-template
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
      variables:
        DEPLOY_ENV: "dev"
    - if: $CI_COMMIT_BRANCH =~ /^release\/(\d+\.\d+\.\d+)$/
      variables:
        DEPLOY_ENV: "stage"
    - if: $CI_COMMIT_TAG =~ /^(\d+\.\d+\.\d+)$/
      variables:
        DEPLOY_ENV: "preprod"

deploy-prod:
  stage: deploy-prod
  extends: .deploy-template
  rules: 
    - when: manual
      if: $CI_COMMIT_TAG =~ /^(\d+\.\d+\.\d+)$/
      variables:
        DEPLOY_ENV: "prod"